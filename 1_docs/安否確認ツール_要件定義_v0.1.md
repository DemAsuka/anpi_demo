## 1. 文書情報

### 1.0. バージョン/更新日時

- バージョン：v0.3
- 最終更新：2025-12-21

### 1.1. 文書名

安否確認ツール 要件定義（v0.3）

### 1.2. 目的

災害発生時に従業員の安否確認と被災状況を迅速に収集し、適切な支援・判断に必要な情報を提供する。

### 1.3. 想定読者

- **経営層/危機管理責任者**：運用方針・意思決定
- **管理者（運用担当）**：発動・周知・未回答者の把握
- **全従業員**：回答手段の利用
- **開発/保守担当**：実装・運用・セキュリティ

### 1.4. 前提

- **コミュニケーション基盤**：Google Workspace、Slack
- **運用規模**：当面は**10人以下**での利用を想定する
- **一次リリース方針**：SNS等のアンケートツール並みに、**Slackで気軽にリアクション**してもらえることを重視する
- **必須要件**
  - **気象庁API（防災情報）の自動連携**で監視し、条件に合致したら自動で安否確認を発動する
  - **発動条件メニュー**（震度/津波/豪雨/河川氾濫/国民保護）は必須（増やせる構成）
- **設定資料（別管理）**
  - 要件定義は「要求/方針」を扱い、運用設定の初期値（ドラフト）や対応表は `1_docs/設定資料/` に別ファイルとして保存し、バージョン管理する
  - 例：`1_docs/設定資料/発動条件メニュー対応表_ドラフト.md`
- **通知方針**：Slackの**チャンネル投稿でOK**
- **回答UI**：**Slack Workflow BuilderでOK**（一次リリースはWorkflow Builderで固定）
- **地域判定**：気象庁側の地域情報と、従業員登録地点（市/区/町/村）の突合は**大まかでOK**
- **実装基盤（一次リリースから採用）**：Vercel + Supabase
- **補完方針**：ネットワーク断やSlack障害を考慮し、将来的にSlack以外の共有/通知方法を検討（本書では将来機能として整理）
- **権限階層**：現時点は「一般社員」「管理者」の2階層とし、**管理者は全権限**

### 1.5. 用語（例）

- **災害イベント**：地震/津波/豪雨/河川氾濫/国民保護など、発動対象となる事象
- **発動条件**：災害イベントを検知して安否確認を開始する条件（設定可能）
- **安否確認（Check）**：管理者または自動発動により送信される回答依頼
- **回答**：従業員がステータス等を送信する行為
- **PII**：個人情報（メール、電話番号、住所、位置情報、家族情報等）

## 2. プロジェクト概要

### 2.1. ゴール

- 災害発生時に、全社員の安否/被災状況を短時間で収集し、未回答者を可視化して個別フォローへつなげる
- **気軽さ**：SNS等のアンケートツール並みに、ワンタップで回答できること

### 2.2. スコープ（一次リリース）

- **災害情報の自動監視（必須）**
  - 気象庁防災情報を定期取得し監視する
  - 発動条件に合致したら自動で安否確認を開始する
- **発動条件メニュー（必須・拡張可能）**
  - 震度/津波/豪雨/河川氾濫/国民保護
  - 有効/無効、閾値、対象地域、クールダウン、テンプレートを設定できる
- **Slackチャンネル投稿で安否確認を周知**
  - チャンネル投稿で「安否確認開始」を告知（災害種別、対象地域、回答方法を明記）
- **Slackでの回答完結（Workflow Builder固定）**
  - Slack Workflow Builderでワンタップ回答（無事/軽傷/重傷/要救助）
- **管理者向けダッシュボード（最小）**
  - 応答/未応答一覧、ステータス別集計、CSV出力
- **拠点/居住地（最大4地点）の登録・見直し依頼**（まずは簡易）

### 2.3. スコープ外（一次リリース）

- ネットワーク断における**完全オフライン回答**（将来機能）
- SMS/音声/メール等の**Slack以外の通知チャネル**（将来機能）
- キャリア災害伝言板APIとの本格連携（実現性調査が必要なため将来機能扱い）

## 3. 要件（機能要件）

### 3.1. 災害情報監視（必須）

- **データソース**
  - **気象庁防災情報（地震・津波・気象警報等）**を定期取得して監視する
- **監視対象**
  - **オフィス拠点**：関東・仙台（地点/地域はマスタで設定）
  - **従業員登録地点**：従業員が登録した居住地等（最大4地点）
- **発動条件メニュー（必須・拡張可能）**
  - 管理者が「発動条件メニュー」を追加・変更できること
  - 発動条件は**種別（メニュー）単位**で設定し、将来的にメニュー追加が可能な構造とする
  - 一次リリースで必須の発動条件メニュー：
    - **a. 震度**
    - **b. 津波**
    - **c. 豪雨**
    - **d. 河川氾濫**
    - **e. 国民保護**
  - 各メニューは、以下の共通属性を持つ（例）：
    - **有効/無効**
    - **対象地域**（全国/拠点/登録地点/指定自治体 等）
    - **閾値/条件**（例：震度○以上、警報種別、レベル 等）
    - **発動アクション**（安否確認開始、Slackへの通知のみ 等）
    - **クールダウン**（同種の連投防止、再発動間隔）
    - **テンプレート**（送信文面、言語）
- **地域判定（大まかでOK）**
  - 気象庁側の地域情報と、拠点/従業員登録地点（市/区/町/村）を**大まかに突合**し対象を決める
  - 厳密な地域コード突合は将来の高度化で扱う
- **誤報/取消**
  - 管理者が発動を手動停止/取消できる（通知テンプレート含む）
- **重複防止**
  - 同一災害イベントの連続発動を防ぐ（イベントID/時刻/クールダウンで制御）

#### 3.1.1. 「同一イベント」判定と通知方針（運用ルール）

一次リリースでは、気象庁XMLの更新頻度や「同じ事象の続報（更新）」を前提に、以下の方針で **通知ノイズ** と **重大化の取り逃がし** を両立する。

- **用語**
  - **災害イベント（Event）**：気象庁から受信する「地震/津波/警報等」の事象（電文の更新を含む）
  - **安否確認（Incident/Check）**：従業員に回答依頼を出し、未回答者管理を開始する単位（Slack投稿＋Workflow回答の対象）
- **クールダウンの定義（重要）**
  - クールダウンは「災害情報の取得」ではなく、同一メニュー（震度/津波/豪雨/河川氾濫/国民保護）で **安否確認（Incident）を新規作成する再発動間隔** を指す
  - 目的：同一事象の続報でIncidentが乱立し、Slackが連投・回答が分散することを防ぐ
- **イベントキー（source_event_key）**
  - 受信電文から **安定した一意キー** を生成し、DBで重複排除の核とする（例：識別子/管理番号/発表時刻/地域などの組合せ）
  - 一意キーが取得できない/揺れる場合は、時刻・地域・種別などで **「同一っぽさ」** を推定し、誤分割/誤統合の影響を最小化する

- **判定の考え方（3分類）**
  - **同一イベント**：一意キー等により同一と判断できる
  - **同一の可能性が高い（推定）**：一意キーは不確実だが、種別・対象地域・時刻などが近く同一の可能性が高い
  - **別イベント**：発生時刻が明確に異なる、対象が大きく異なる等で別事象と判断できる

- **Slack通知の基本方針**
  - **新規Incident作成（回答依頼）**：発動条件を初めて満たしたタイミングで実施する
    - 例：初報 震度3（未満）→更新で震度5（閾値超過）になった時点で、安否確認を開始し回答依頼を投稿する
  - **同一イベントの更新**：原則、チャンネルを荒らさないため **同一Incidentのスレッドに更新情報を追記**する（実装方式によりメッセージ更新/スレッド投稿等）
  - **別イベント**：重大災害の取り逃がしを避けるため、原則 **クールダウンによる抑止を行わず** 新規Incidentとして発動する（※ただし「同一の可能性が高い（推定）」は運用で方針を選択可能）

- **重大化/対象拡大の例外（強通知）**
  - 同一イベント扱いであっても、以下のいずれかに該当する場合は **クールダウンに関係なく強い再通知**（例：チャンネル再掲、@here、管理者通知強化等）を行える
    - 重大化（例：最大震度が上昇、注意報→警報、危険度上昇）
    - 対象地域の拡大により、新たに拠点/従業員登録地点が対象に含まれた
    - 取消/解除（終息連絡）

- **管理者向け通知（運用補助）**
  - 同一イベントが長時間継続し更新が多い場合、チャンネルのノイズ抑制のため、一定時間経過後の更新は **管理者のみに通知**する運用を選択できる
  - 未回答者通知（SLA：個別フォロー）とは別に扱い、運用で頻度を調整する

### 3.2. 安否確認（回答収集）

- **配信**
  - 気象庁監視により、発動条件に合致した場合に自動で開始できる
  - 管理者は手動で安否確認を開始できる（訓練/テスト含む）
  - 周知はSlackチャンネル投稿で行う
- **回答（Slackで完結）**
  - **Slack Workflow Builder**で、ワンタップで回答できるUI（ボタン選択）を提供する（一次リリースはWorkflow Builderで固定）
  - 必須ステータス（例）：
    - **無事**
    - **軽傷**
    - **重傷**
    - **要救助**
  - 任意入力：
    - **自由記述（状況）**
    - **家族を含めた被災状況**（定義は後述）
    - **位置情報共有**（任意、プライバシー設定可能）
- **SLAと未回答者フォロー**
  - 本ツールのSLAは「**個別フォロー**」方針とする
  - ツールは「**情報発信と回答依頼**」「**未回答者の管理者への報告**」までを担う
  - 未回答者に対する電話等の追加フォローは、状況に応じて管理者が個別対応する

- **集計（一次リリース）**
  - 回答は**Supabase（PostgreSQL）**に記録し、管理者が一覧/集計できること

### 3.3. 拠点/居住地（最大4地点）登録

- **登録地点数**
  - 1人につき、以下の**最大4地点**を登録できる：
    - **自宅**
    - **実家**
    - **出張先**
    - **その他**
- **登録粒度**
  - 市がある場合は **「市」**
  - 市がない場合は **「区」または「町」または「村」**
  - 住所の詳細（丁目番地等）や緯度経度の扱いは、別途「未確定事項」で確定する
- **見直し運用**
  - 定期的に登録情報を見直す（例：四半期/半期）
  - ツールに「**見直し依頼（更新リクエスト）**」機能を設ける
  - 見直し依頼はSlackで通知し、所定期間内の更新有無を管理者が把握できる

### 3.4. 情報管理ダッシュボード（管理者）

- **リアルタイム可視化**
  - 安否確認ごとに、以下を一覧表示できる：
    - **応答者/未応答者**
    - **ステータス別集計**
    - **要救助/重傷など支援優先対象の抽出**
- **フィルタリング**
  - 部署/地域/状況別（将来はGoogle Directory属性との連携も検討）
- **エクスポート**
  - CSV出力（出力項目はロールにより制御）
  - CSV出力は監査ログ対象とする
- **地図表示（将来を見据えた要件）**
  - 地図上の重ね合わせ表示は、位置情報の扱いが確定次第実装（一次リリースは「地域単位」の可視化を優先）

### 3.5. コミュニケーション（一次は最小構成）

- **緊急連絡掲示板（会社アナウンス）**
  - 管理者からの告知をSlackに掲出できる（テンプレート化）
- **相互支援の調整**
  - 二次以降で検討（個人間でPIIが露出しやすいため、権限/同意/監査設計が前提）
- **避難所・医療機関情報**
  - 二次以降で検討（情報ソース、表示粒度、責任範囲の確定が必要）

## 4. 要件（非機能要件）

### 4.1. セキュリティ/プライバシー

#### 4.1.1. 推奨ツール構成（Google Workspace / Slack 前提）

一次リリースは「気軽さ」と「自動監視の必須要件」を両立するため、Vercel＋Supabaseを中核に構成する。

- **Slack（Workflow Builder）**
  - 通知は**チャンネル投稿**
  - 回答収集のUIをSlack内に閉じる（一次リリースはWorkflow Builderで固定）
  - Slackメッセージやフォームに、住所/電話など**不要なPIIを書かせない**（注意文をテンプレに含める）
- **Vercel**
  - 管理者向けダッシュボード（Web）
  - 気象庁APIの定期監視（Cron/スケジュール実行）
  - Slack通知の送信（Webhook/トークン利用）
- **Supabase**
  - DB（PostgreSQL）：従業員/登録地点/発動条件/災害イベント/回答を保持
  - 将来の権限強化（RLS等）に対応
  - 認証（必要なら）：管理者画面のログイン（Google Workspace連携など）

- **認証**
  - 管理者画面は認証必須（Supabase Auth等）
  - 管理者のGoogleアカウントは**MFA強制**（Google側ポリシーで統制）
- **認可（RBAC）**
  - 現時点は2ロール：
    - **一般社員**
    - **管理者（全権限）**
  - 将来の役割追加（例：部門管理者、拠点管理者、経営閲覧者）を想定し、RBACは拡張可能な設計とする
- **暗号化**
  - **通信の暗号化**：TLS
  - **保存時暗号化**：DB/オブジェクトストレージ暗号化
  - **フィールド単位暗号化**：住所/電話等のPIIは追加暗号化を検討
  - 「エンドツーエンド暗号化」は本要件の定義を明確化（未確定事項参照）
- **監査ログ**
  - ログ対象（例）：
    - ログイン/権限変更
    - PIIの閲覧
    - CSV出力
    - 発動条件変更
    - 安否確認の開始/取消
- **データ最小化**
  - 住所は「市/区/町/村」粒度を基本とし、詳細住所は原則収集しない（例外が必要な場合は別途合意）

### 4.2. 可用性/BCP（一次は方針、数値は未確定）

- 災害時のアクセス集中を想定し、スケール可能な構成を前提とする
- RTO/RPO、DR（リージョン冗長）方針は未確定事項として後続で確定する

### 4.3. 性能

- 大量同時送信時も、管理者が「未回答者一覧」を実用的な遅延で把握できること
- Slack APIのレート制限を考慮し、送信キュー/リトライ方針を持つ

### 4.4. 多言語/アクセシビリティ

- 多言語：日本語/英語
- アクセシビリティ：スクリーンリーダー対応、高コントラスト、文字サイズ調整（達成基準は未確定）

## 5. 技術要件（実装方針）

### 5.1. 基本スタック（案）

**一次リリース（v0.3）**

- **Web/ダッシュボード**：Vercel（例：Next.js）
- **定期実行/バックエンド処理**：Vercel Cron（気象庁監視、判定、通知）
- **DB**：Supabase（PostgreSQL）
- **回答UI**：Slack Workflow Builder
- **通知**：Slackチャンネル投稿（Incoming Webhook等）

**将来拡張（必要になったら）**

- Slack App（インタラクティブボタン/DM/高度なUI）
- AWS（キュー、WAF、鍵管理、監査、DRなどの強化）

### 5.2. 外部連携

- **Slack**：通知（チャンネル投稿）、回答（Workflow Builder）
- **Google Workspace**：組織ポリシー（MFA等）、（必要になったらDirectory同期）
- **気象庁防災情報**：自動監視で利用
- **地図**：将来（位置情報の要件確定後）

## 5.3. データ/画面の最小要件（一次リリース）

### 5.3.1. 従業員の登録情報（一次）

- **必須（想定）**
  - 氏名（Directoryから連携）
  - 社員ID等（Directoryまたは連携元の識別子）
- **任意（PII）**
  - 連絡先：メール、電話番号（登録される可能性あり）
  - 登録地点（最大4）：自宅/実家/出張先/その他
    - 粒度：市/区/町/村

### 5.3.2. 安否確認の回答項目（一次）

- **必須**
  - ステータス：無事/軽傷/重傷/要救助
- **任意**
  - 自由記述（状況）
  - 家族情報（一次は最小入力に留め、詳細は未確定として後続で確定）
    - 例：家族に負傷者あり/なし、支援要否（Yes/No）
  - 位置情報共有（任意、同意/粒度/保存期間は未確定事項）

## 6. 権限マトリクス（役割×見える項目）

前提：現時点は2階層のみ（管理者は全権限）。将来の役割追加に備えて項目単位で整理する。

### 6.1. 役割定義

- **一般社員**：自分の情報登録・自分の回答・自分宛の通知を扱う
- **管理者**：全件閲覧・運用（発動条件、送信、集計、エクスポート、監査）

### 6.2. マトリクス（一次リリース）

| 項目/操作 | 一般社員 | 管理者 |
|---|---:|---:|
| 自分の登録地点（最大4）を閲覧/更新 | ○ | ○ |
| 他者の登録地点（市/区/町/村）を閲覧 | × | ○ |
| 他者の連絡先（メール/電話）を閲覧 | × | ○ |
| 自分の回答（ステータス/自由記述/家族情報）を登録/修正 | ○（制限付き） | ○ |
| 他者の回答を閲覧 | × | ○ |
| 未回答者一覧を閲覧 | × | ○ |
| 安否確認の開始/取消（手動） | × | ○ |
| 発動条件メニュー/閾値の追加・変更 | × | ○ |
| テンプレート（文面）編集 | × | ○ |
| CSVエクスポート | × | ○ |
| 監査ログ閲覧 | × | ○ |

### 6.3. 将来の役割案（参考）

- **経営閲覧者**：集計と重大案件のみ閲覧（PII最小）
- **部門管理者/拠点管理者**：担当範囲のみ閲覧
- **人事/総務**：PII閲覧は必要最小限＋監査強化

## 7. データ保持ポリシー（案）

※法務/社内規程により調整する。ここでは「最小化」と「追跡可能性（監査）」の両立を狙う。

### 7.1. データ分類

- **マスタ**：従業員、部署、拠点、登録地点（市/区/町/村）
- **運用設定**：発動条件メニュー、閾値、テンプレート、通知設定
- **イベント/回答**：災害イベント、安否確認、回答、未回答状態
- **監査**：閲覧/出力/変更の記録
- **出力物**：CSVファイル、レポート

### 7.2. 保持期間（案）

一次リリースはSupabaseでの運用を前提に、**保持を短め**にし、不要なPIIを持たない設計とする。

| データ種別 | 目的 | 保持期間（案） | 削除/匿名化 |
|---|---|---:|---|
| 従業員マスタ | 運用の基礎 | 在籍中 + 退職後○ヶ月 | 退職後に削除（または匿名化） |
| 登録地点（市/区/町/村） | 地域判定 | 在籍中 | 退職時削除 |
| 運用設定（発動条件/テンプレ） | 運用 | 変更履歴○年 | 履歴保持（監査目的） |
| 災害イベント/安否確認 | 事後検証 | ○年 | 期限到来で削除 |
| 回答（ステータス/自由記述/家族情報） | 支援判断 | ○年（短め推奨） | 期限到来で削除（必要に応じ匿名化） |
| 監査ログ | 不正追跡 | ○年 | 改ざん耐性のある保管で保持 |
| CSV出力 | 一時共有 | 生成後○日 | 自動削除、再生成可能にする |

### 7.3. 取り扱いルール

- **PIIを含むCSVは原則禁止/最小項目**（必要な場合のみ、権限と監査を必須）
- **出力物は自動削除**し、共有は期限付き・アクセス制御付きで行う
- **アクセス/出力/設定変更は監査ログに記録**する

### 7.4. MVP（Supabase）運用での具体ルール（案）

- **アクセス制御**
  - 管理者画面は認証必須（Supabase Auth等）
  - DBは権限設計（将来のRLS適用を前提）
- **保持**
  - 回答データは**イベント終了後○ヶ月**で削除（まずは短め推奨：1〜3ヶ月）
  - 訓練データは本番と論理的に分離し、短期削除
- **PII**
  - 一次リリースは、電話番号/詳細住所などのPIIを極力収集しない
  - 自由記述欄にはPIIを書かない旨をテンプレに明記

## 8. 発動/エスカレーション運用フロー

### 8.1. 発動（自動）

- Vercelの定期実行で気象庁防災情報を取得する
- 発動条件メニュー（震度/津波/豪雨/河川氾濫/国民保護）ごとのルールに照らし、**発動判定**
- 発動した場合：
  - **災害イベント**をDBに作成（種別、地域、根拠、時刻等）
  - 対象者へ**Slackチャンネル投稿**で安否確認開始を通知（回答方法を明記）
  - 管理者向けダッシュボードに反映（応答/未応答の起点を作る）

### 8.2. 発動（手動/訓練）

- 管理者が任意に安否確認を開始（災害/訓練を区別できる）
- 送信対象（全社/拠点/任意グループ）を指定できる（詳細は未確定事項）

### 8.3. 回答収集と未回答者報告（SLA：個別フォロー）

- 従業員はSlack上で回答（ボタン＋任意入力）
- 管理者はダッシュボードでリアルタイム集計
- 必要に応じて、一定時間ごとに以下を自動実施：
  - **未回答者一覧を管理者に通知**（Slack）
  - 重大ステータス（重傷/要救助）を優先表示
- 以降の電話等は管理者が個別に実施（ツールは記録・可視化を支援）

### 8.4. 終了・事後対応

- 管理者が安否確認を「終了」状態にし、最終集計を確定
- 必要に応じてレポート出力（監査ログ対象）
- データ保持ポリシーに基づき、期限到来で自動削除

## 9. 未確定事項（要件を定め切れていないこと）

- **「エンドツーエンド暗号化」の定義**：本システムで何をE2E対象にするか（ダッシュボード集計との両立可否）
- **Slack以外の共有/通知**：
  - メール/SMS/音声の採用有無、優先順位、冗長化、費用
  - Slack障害時の代替手段（最小のバックアップ導線）
- **ネットワーク断/オフライン**：
  - オフライン回答の要否（モバイルアプリ/ローカル保存/再送）
- **地図・位置情報**：
  - 収集する粒度（市区町村のみ/緯度経度）
  - 保存期間、同意、閲覧権限、表示方法
- **家族情報の定義**：
  - 入力項目（人数/状態/連絡可否等）と同意、閲覧範囲
- **対象者のグルーピング**：
  - 拠点/部署/任意タグ等の扱い（Directory同期項目の採用）
- **RTO/RPO、DR方針**：復旧目標とバックアップ/復元演習
- **アクセシビリティの達成基準**（例：WCAGレベル）
- **監査ログの保管方式/期間**：社内規程との整合
- **API利用条件**：
  - 気象庁データの取得方式・頻度・制約
  - キャリア災害伝言板は実現性調査（契約/公開API有無）

## 10. 今後搭載する機能一覧（将来機能候補）

### 10.0. 段階導入の方針

- 一次リリースは **Vercel＋Supabase＋Slack（Workflow Builder）** を中核に、最小機能で「自動発動→Slack周知→気軽な回答→未回答者把握」を成立させる
- 多チャネル通知、オフライン、厳密な地域コード突合、強い監査・暗号化などは、運用が回り始めてから段階導入する

### 10.1. 通知チャネルの拡張（到達性向上）

- **メール通知**
- **SMS通知**（事業者冗長化含む）
- **音声自動発信（コールツリー）**
- **Push通知（モバイルアプリ）**
- チャネル優先順位/フォールバック/再送ポリシー

### 10.2. オフライン/災害耐性

- モバイルアプリでの**オフライン回答**（ローカル保存→復帰時送信）
- 低帯域モード（画像添付禁止、最小ペイロード）
- DR（マルチリージョン）・BCP強化

### 10.3. 権限と組織連携の高度化

- 役割追加（経営閲覧者、部門管理者、拠点管理者）
- Google Directoryとの属性同期強化、SCIM自動プロビジョニング
- PIIのマスキング表示（「必要な時だけ」解除、監査強化）

### 10.3.1. Slack UIの高度化（必要になったら）

- Slack App（インタラクティブボタン、スレッド誘導、DM、権限に応じた表示制御の高度化）

### 10.4. レポーティング/支援最適化

- 自動レポート生成（テンプレ＋指標）
- 支援優先度のルールエンジン（回答×地域×災害種別）
- 訓練モードの定期実施と結果の分析

### 10.5. 情報提供機能

- 避難所/医療機関情報の自動提示（情報ソース確定後）
- 社内掲示板の整備（重要情報の固定、既読管理）


