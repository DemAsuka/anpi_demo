## 構築マニュアル（Vercel + Supabase + Slack Workflow + 気象庁自動監視）

### 文書情報

- バージョン：v0.1
- 作成日：2025-12-21
- 対象：10人以下規模の安否確認ツール（自動監視→自動発動→Slackチャンネル通知→Workflow回答→管理画面集計）

---

## 1. 前提（この手順が対象にする構成）

- **Vercel**：Web（管理画面）＋API＋Cron（1分監視）
- **Supabase**：Postgres（データ）＋Auth（管理画面ログイン）
- **Slack**：通知は**チャンネル投稿**、回答は**Workflow Builder**（投稿内リンク/案内で起動）
- **気象庁防災情報**：**1分間隔で自動監視**し、発動条件メニュー（震度/津波/豪雨/河川氾濫/国民保護）で判定

---

## 2. 事前に用意するもの（チェックリスト）

- Slackワークスペースの管理権限（Workflow作成、Incoming Webhook作成）
- Supabaseの管理権限（新規Project作成、SQL実行）
- Vercelの管理権限（Project作成、Cron設定、環境変数設定）
- 運用用Slackチャンネル（例：`#anpi`）と、管理者ユーザー

---

## 3. Supabase 構築

### 3.1. Project作成

1. Supabaseで新規Project作成（Region選択、DBパスワード設定）
2. Project作成後、接続情報を控える
   - **Project URL**
   - **anon key**
   - **service role key**（重要：サーバー側のみで使用、絶対にクライアントへ渡さない）

### 3.2. Auth設定（管理画面ログイン）

1. Supabase Authを有効化
2. 管理画面だけログイン必須にする
3. 可能なら **Google Workspace（Google OAuth）** を追加
   - 最初は「メール＋マジックリンク」でもOK（簡易優先）

### 3.3. DBスキーマ作成（SQL）

SupabaseのSQL Editorで以下を実行し、最小スキーマを作成します。

```sql
create type incident_status as enum ('open','closed','cancelled');
create type response_status as enum ('safe','minor_injury','serious_injury','need_rescue');
create type location_kind as enum ('home','parents','business_trip','other');
create type trigger_type as enum ('shindo','tsunami','heavy_rain','river_flood','civil_protection');

create table if not exists users (
  id uuid primary key default gen_random_uuid(),
  slack_user_id text unique not null,
  display_name text,
  email text,
  is_admin boolean not null default false,
  created_at timestamptz not null default now()
);

create table if not exists user_locations (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references users(id) on delete cascade,
  kind location_kind not null,
  locality text not null,
  updated_at timestamptz not null default now(),
  unique (user_id, kind)
);

create table if not exists trigger_rules (
  id uuid primary key default gen_random_uuid(),
  type trigger_type not null,
  enabled boolean not null default true,
  threshold jsonb not null default '{}'::jsonb,
  target_scope jsonb not null default '{}'::jsonb,
  cooldown_minutes int not null default 60,
  template text not null default '',
  updated_at timestamptz not null default now(),
  unique (type)
);

create table if not exists jma_events (
  id uuid primary key default gen_random_uuid(),
  source_type trigger_type not null,
  source_event_key text not null,
  published_at timestamptz,
  payload jsonb not null,
  created_at timestamptz not null default now(),
  unique (source_type, source_event_key)
);

create table if not exists incidents (
  id uuid primary key default gen_random_uuid(),
  trigger_type trigger_type not null,
  reason text not null,
  target_summary text not null default '',
  status incident_status not null default 'open',
  created_at timestamptz not null default now(),
  closed_at timestamptz
);

create table if not exists incident_targets (
  id uuid primary key default gen_random_uuid(),
  incident_id uuid not null references incidents(id) on delete cascade,
  user_id uuid not null references users(id) on delete cascade,
  unique (incident_id, user_id)
);

create table if not exists responses (
  id uuid primary key default gen_random_uuid(),
  incident_id uuid not null references incidents(id) on delete cascade,
  user_id uuid not null references users(id) on delete cascade,
  status response_status not null,
  comment text,
  responded_at timestamptz not null default now(),
  unique (incident_id, user_id)
);

create table if not exists audit_logs (
  id uuid primary key default gen_random_uuid(),
  actor text not null,
  action text not null,
  detail jsonb not null default '{}'::jsonb,
  created_at timestamptz not null default now()
);
```

---

## 4. Slack 構築

### 4.1. 通知用：Incoming Webhook

1. SlackのApp管理から **Incoming Webhook** を作成
2. 投稿先チャンネルを `#anpi` に設定
3. Webhook URLを控える（Vercelの環境変数へ設定）

### 4.2. 回答用：Workflow Builder

1. Workflow Builderで「安否確認回答」ワークフローを作成
2. 入力項目（最小）
   - ステータス（必須）：無事/軽傷/重傷/要救助
   - コメント（任意）
   - （任意）本人特定が難しい場合は「氏名」入力（運用次第）
3. “送信先”は **Webhook（Vercel API）** にする
   - WorkflowのWebhookステップで `POST` を叩き、回答内容を送る
4. 起動方法は「**チャンネル投稿内のリンク/案内から起動**」にする
   - 通知投稿に、起動手順（リンク or 画面操作）を必ず記載する

---

## 5. Vercel 構築（アプリ本体）

### 5.1. プロジェクト作成とデプロイ

1. Webアプリ（例：Next.js）を用意してVercel Projectを作成
2. mainブランチのデプロイを確認

### 5.2. 環境変数（Vercel Project Settings）

最低限、以下を登録します。

- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`（サーバー専用）
- `SUPABASE_ANON_KEY`（必要なら）
- `SLACK_WEBHOOK_URL`
- `CRON_SECRET`

気象庁監視に必要な設定は実装方式に応じて追加します（例：取得URL、監視対象種別など）。

### 5.3. 必要なAPI/ジョブ（実装要件）

- `POST /api/responses`
  - Workflow Builderから受信 → 検証 → Supabaseへ保存
- `POST /api/cron/jma`
  - 1分ごとに気象庁データを取得 → ルール判定 → `incident` 作成 → Slack投稿
  - `jma_events` のユニーク制約＋クールダウンで二重発動を防ぐ
- 管理画面（`/admin` 等）
  - incident一覧/詳細（回答/未回答）、ルール編集（`trigger_rules`）、CSV出力

### 5.4. Cron（1分）

1. Vercel Cronで `POST /api/cron/jma` を **1分**で実行
2. `CRON_SECRET` をヘッダ等で送る（Cron以外から叩かれないようにする）

---

## 6. 気象庁監視ソースの確定（実装前の必須作業）

- 監視対象（必須）：震度/津波/豪雨/河川氾濫/国民保護
- 「大まかでOK」前提でも、最低限以下を確定します。
  - どのデータを取るか（フィード/URL）
  - どのフィールドで `source_event_key` を作るか（重複防止の核）
  - ルールの初期閾値（暫定でも可）


