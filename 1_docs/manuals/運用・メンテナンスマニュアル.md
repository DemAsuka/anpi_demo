## 運用・メンテナンスマニュアル（Vercel + Supabase + Slack Workflow）

### 文書情報

- バージョン：v0.1
- 作成日：2025-12-21
- 対象：10人以下規模の安否確認ツール

---

## 1. 運用の基本方針（MVP）

- 通知はSlack **チャンネル投稿**で実施
- 回答はSlack **Workflow Builder**で収集（投稿内のリンク/案内から起動）
- 監視は1分間隔で自動実行（Vercel Cron）
- SLAは「未回答者を把握し、必要に応じて個別フォロー」

---

## 2. 日常運用

### 2.1. 日次（1〜2分）

- VercelのCron（気象庁監視）が直近で成功しているかを確認
- Slack `#anpi` にエラー通知や異常投稿がないか確認

### 2.2. 週次（10分）

- 誤発動/漏れがないか確認し、必要なら閾値・クールダウンを微調整
- Supabaseのエラー/負荷状況（失敗ログ、接続、容量）を確認

---

## 3. 運用手順（よくある作業）

### 3.1. 従業員の追加/削除（10人規模向け）

- 追加：`users` に SlackユーザーID、表示名、（任意）メールを登録
- 削除/対象外：
  - 履歴を残す必要がある場合は論理削除（例：対象外フラグ）を推奨
  - 完全削除の場合は `users` を削除（関連データが消える点に注意）

### 3.2. 登録地点（市/区/町/村）の更新・見直し依頼

- 定期（例：四半期/半期）にSlackで見直しを周知
- 更新は運用に応じて
  - 管理画面で入力（管理者代行）
  - もしくは簡易フォームを用意（将来改善）

### 3.3. 発動条件メニュー（5種）の変更

- 管理画面で `trigger_rules` を更新
- 更新時は `audit_logs` に記録（誰が/いつ/何を変更）
- 変更後、可能なら訓練（手動発動）で動作確認

### 3.4. 安否確認の手動開始（訓練/臨時）

- 管理画面から「手動発動」を実行
- Slack投稿で「訓練」であることを明記し、Workflow起動手順を添える

### 3.5. 誤発動時の対応

1. 管理画面で該当incidentを `cancelled` に変更
2. `#anpi` に「誤報」周知を投稿（テンプレ化推奨）
3. 原因（閾値/データ解釈/重複判定）をメモし、`trigger_rules` を修正

### 3.6. イベント終了処理

- incidentを `closed` に変更し、最終集計を確定
- 保持期限に従い、期限到来で削除（自動ジョブ推奨）

---

## 4. 障害対応（Runbook）

### 4.1. Cronが動いていない

1. Vercelのログで Cron の呼び出し履歴を確認
2. 失敗理由を切り分け
   - 外部取得失敗（気象庁）
   - DB接続/認証失敗（Supabase）
   - タイムアウト
3. 一時回避：管理者が手動発動（臨時投稿）で運用継続

### 4.2. Slackに投稿できない

1. `SLACK_WEBHOOK_URL` の失効/変更を確認
2. Slack側の制限/権限を確認
3. 一時回避：管理者が手動投稿で周知し、Workflow起動手順を案内

### 4.3. 回答が保存されない

1. Vercel APIのエラーログを確認（`/api/responses`）
2. Supabaseのキー/URL等の環境変数を確認
3. 一時回避：回答はSlackで受け、後から管理者が手動記録（最終手段）

---

## 5. セキュリティ/データ保護（最低限）

### 5.1. 秘密情報の管理

- `SUPABASE_SERVICE_ROLE_KEY` と `SLACK_WEBHOOK_URL` はVercelの環境変数のみで管理
- 漏えい時は即時ローテーション（差し替え）する

### 5.2. PII最小化

- 住所は市/区/町/村まで（詳細住所は原則保持しない）
- Workflowのコメント欄に住所/電話番号を書かない注意文を常に表示

### 5.3. データ保持

- incident終了後 **1〜3ヶ月**で削除（要件に合わせて確定）
- 訓練データは本番と分離し、短期間で削除

---

## 6. 定期メンテナンス（推奨）

### 6.1. 月次

- `trigger_rules` の棚卸し（enabled、閾値、クールダウン、テンプレ）
- 監視の取りこぼし/誤発動があれば改善メモを残す

### 6.2. 半年〜年次

- Slack Webhookの見直し（不要なら再発行）
- Supabaseのキーのローテーション（運用可能なら）
- 依存ライブラリ（Vercel側）の更新（セキュリティ優先）


