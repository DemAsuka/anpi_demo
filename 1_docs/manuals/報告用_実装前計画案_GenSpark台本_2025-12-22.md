## 実装前 計画案（GenSpark上で説明する用：台本）

### 0. 目的（最初の30秒）

- 災害発生時に、従業員の安否/被災状況を**短時間で集約**し、未回答者を可視化して**個別フォロー**につなげる。
- 一次リリースは**10人以下のMVP**として、**Slackで気軽にワンタップ回答**できることを最優先。
- 必須要件として、**気象庁防災情報の自動監視→条件一致で自動発動**を満たす。

---

### 1. 今回の構成（結論：1分）

- **Vercel**：管理画面（Web）＋ API ＋ Cron（60秒監視）
- **Supabase**：PostgreSQL（データ）＋ Auth（管理画面ログイン）
- **Slack**：チャンネル投稿で周知／Workflow Builderで回答収集（WebhookでAPIへPOST）
- **気象庁 XML Pull**：`regular/extra/eqvol/other` を60秒ポーリング

狙い：
- 「自動監視」と「気軽な回答」を両立し、まずは最小構成で運用に乗せる。

---

### 2. 全体図（口頭説明の軸：1分）

（図の要素）
- [JMA XML feeds] → [Vercel Cron /api/cron/jma]
  - 60秒で取得
  - 重複排除・更新判定
  - 発動条件に合致したら incident 作成
- [Vercel] → [Supabase(Postgres)]：イベント/安否確認/回答/監査ログを保存
- [Vercel] → [Slack #anpi]：安否確認開始を投稿（更新はスレッド追記想定）
- [Slack Workflow] → [Vercel /api/responses] → [Supabase]：回答保存→管理画面に反映

---

### 3. 監視・重複排除・更新通知（突っ込まれポイント：1分）

- 監視は**60秒間隔**（Vercel Cron）
- 取得した電文は「同じ電文の続報（更新）」が多い前提なので、以下でノイズを抑える：
  - **entry_key**：`atom_entry_id` を優先、なければ `atom_entry_link_href`
  - **content_hash**：`title / updated / link` を基に作成
  - entry_keyが同じでcontent_hashが同じ → 通知しない
  - entry_keyが同じでcontent_hashが変わる → 「更新」として扱い、**スレッド追記**などで共有
- 「クールダウン」は**“同一メニューで incident を新規作成する再発動間隔”**で、取得自体は止めない。

---

### 4. 発動条件メニュー（必須5種）と初期値（1〜2分）

一次リリース必須（拡張可能な設計）：
- **震度**：最大震度 **5弱以上**で発動、クールダウン **60分**
- **津波**：**警報以上**で発動（注意報は通知のみ運用も可）、クールダウン **60分**
- **豪雨**：まず **特別警報のみ**で発動、クールダウン **180分**
- **河川氾濫**：**氾濫危険以上**で発動（運用で調整可）、クールダウン **180分**
- **国民保護**：受信したら発動、クールダウン **60分**

対象地域判定（一次は割り切り）：
- 拠点（関東・仙台）＋従業員登録地点（市区町村）を基に、電文の対象地域と**大まかに突合**
- 厳密な地域コード突合は将来の高度化で扱う

---

### 5. 一次リリースのスコープ（30秒）

含む：
- 自動監視 → 自動発動 → Slack周知 → Workflow回答 → 未回答者/集計 → CSV出力

含まない（将来）：
- オフライン回答、Slack以外の通知（SMS/メール等）、厳密な地域コード突合、強いDR/監査強化

---

### 6. セキュリティ/PII（30〜45秒）

- **PII最小化**：住所は市区町村粒度、詳細住所は原則収集しない
- Workflowのコメント欄には**住所/電話等を書かない注意文**をテンプレに入れる
- 秘密情報はVercel環境変数で管理（`SUPABASE_SERVICE_ROLE_KEY` / `SLACK_WEBHOOK_URL` 等）
- CSV出力、設定変更、発動/取消は監査ログ対象

---

### 7. 運用（MVPの回し方：30〜45秒）

- 日次：Cron成功、Slack異常投稿の有無を確認
- 週次：誤発動/漏れ確認、閾値・クールダウンを微調整
- 誤発動：incidentをcancel→誤報周知→原因メモ→ルール修正（再発防止）
- Cron/Slack障害時：管理者の**手動発動**で暫定運用（最小のBCP）

---

### 8. 未確定事項（確認したい論点：30秒）

- 閾値初期値の妥当性（誤発動 vs 取り逃がしのバランス）
- データ保持期間（例：incident終了後 1〜3ヶ月の確定）
- Slack障害時の代替（最低限のバックアップ導線を持つか）
- 位置情報/家族情報の扱い（同意・粒度・閲覧権限）
- RTO/RPO、DR方針

---

### 9. 想定QA（講師/上司向け）

1) なぜSlack AppではなくWorkflow Builder？  
→ 一次は実装負荷を抑え「気軽さ」を最優先。必要になったらSlack Appへ段階導入する前提。

2) 60秒監視は重くない？  
→ 10人規模のMVP前提。重複排除＋更新抑制でノイズを抑える。運用で間隔は調整可能。

3) 誤発動したら？  
→ incident取消（cancelled）＋誤報テンプレで即周知し、原因に応じて閾値/判定/クールダウンを調整する。

4) 個人情報は大丈夫？  
→ 市区町村粒度＋SlackコメントにPIIを書かせない＋管理画面認証＋監査ログで最小化する。

5) Slackが落ちたら？  
→ 一次は“完全冗長”はスコープ外。最小の代替（手動周知・後追い記録）を用意し、必要に応じて多チャネル化を検討。

---

## GenSpark貼り付け用（発表原稿生成プロンプト）

以下をそのままGenSparkに貼ってください（10枚以内の「スライド相当」出力）。

```text
日本語で「実装前の計画案」を、GenSpark上で口頭説明できる“スライド相当の章立て”として作成してください。
出力は10枚以内。各“スライド”に以下を含めてください：
- タイトル（1行）
- 箇条書き（3〜6行）
- 話す内容（スピーカーノート 3〜5行）
- 図が必要なら「図の要素（箱/矢印/注釈）」を文章で

題材：安否確認ツール（MVP、10人以下）

【目的】
- 災害時に安否/被災状況を短時間で収集し、未回答者を可視化して個別フォローにつなげる
- Slackで気軽にワンタップ回答できることを最優先
- 必須：気象庁防災情報の自動監視→条件一致で自動発動

【今回の構成（結論）】
- Vercel：Web管理画面 + API + Cron（60秒監視）
- Supabase：PostgreSQL（データ）+ Auth（管理画面ログイン）
- Slack：チャンネル投稿で周知、Workflow Builderで回答収集（WebhookでVercel APIへPOST）
- 気象庁 XML Pull：regular/extra/eqvol/other を60秒ポーリング

【重複排除・更新通知方針】
- entry_key：atom_entry_id優先、fallbackでatom_entry_link_href
- content_hash：title/updated/link
- 同一entry_keyでhash同一→通知しない、hash変更→更新として共有（スレッド追記想定）
- クールダウンは「同一メニューでincident新規発動する最短間隔」

【発動条件メニュー（必須5種）と初期値】
- 震度：最大震度5弱以上、cooldown60
- 津波：警報以上で発動（注意報は通知のみ運用も可）、cooldown60
- 豪雨：特別警報のみで発動、cooldown180
- 河川氾濫：氾濫危険以上で発動、cooldown180
- 国民保護：受信したら発動、cooldown60
- 対象地域：拠点（関東・仙台）/従業員登録地点（市区町村）と電文対象地域を大まかに突合（厳密コード突合は将来）

【一次リリーススコープ】
- 自動監視→自動発動→Slack周知→Workflow回答→未回答/集計→CSV
- スコープ外：オフライン回答、Slack以外通知、厳密地域コード突合

【セキュリティ/PII】
- 住所は市区町村粒度、詳細住所は原則保持しない
- WorkflowコメントにPIIを書かない注意
- 秘密情報はVercel環境変数管理、漏えい時はローテーション
- 監査ログ（CSV出力、設定変更、発動/取消）

【運用】
- 日次/週次の確認
- 誤発動時の取消と周知
- Cron/Slack障害時は手動発動で暫定運用

最後に「想定QA 5問」と「意思決定が必要な論点 3〜5個」を付けてください。
```


