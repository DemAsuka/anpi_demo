# 次ステップ：気象庁ポーリング（XML feeds）技術資料更新時の運用

## 本番資料の参照

「気象庁 XML Pull（`regular/extra/eqvol/other`）を定期ポーリングし、重複排除・更新判定する」方針を参照しています。

- 参照: `1_docs/manuals/報告用_実装前計画案_GenSpark台本_2025-12-22.md`

## 背景（なぜ運用が必要か）

気象庁の **開発者向けXMLフィード**は、以下のような変更が起こり得ます。

- feed/entry の要素や属性の追加・変更（例：linkの構造、idの形式）
- `updated` の扱い（フォーマット、空値など）
- 取得元URLの追加・廃止
- 仕様更新に伴う「更新通知のノイズ増」（＝`changed` が急増する）

これにより、以下の障害が起き得ます。

- パース失敗（例外でCronが落ちる）
- `entry_key` が変わって重複排除が効かない（大量通知）
- `content_hash` が変わり続けて更新扱いが止まらない（大量通知）

## 対象（現状の実装）

- 監視エンドポイント：`GET /api/cron/jma?token=...`
- 主要データ：
  - `jma_entries.entry_key`（重複排除キー）
  - `jma_entries.content_hash`（更新判定）
- 実装箇所：
  - `web/src/app/api/cron/jma/route.ts`

## 運用設計（検知→影響確認→修正→検証→反映）

### 1) 変更の「検知」

推奨（いずれか）：

- **人手検知**：気象庁の開発者向けページ/更新履歴を定期確認（週次）
- **症状検知**：以下のシグナルを監視
  - Cron実行の 5xx 増加
  - `changed` が異常に増える（例：普段は数十なのに数千）
  - Slack（デモDM/本番チャンネル）通知が短時間に増える

### 2) 影響範囲の切り分け（最優先）

- **パース失敗**か？
  - Cronレスポンスが 500 / エラーログに XMLParser 周りの例外
- **重複排除が破綻**か？
  - `entry_key` が急に別物になり、`jma_entries` が急増
- **更新判定が破綻**か？
  - `content_hash` が安定せず、同じ電文を更新扱いし続ける

### 3) 一時しのぎ（被害抑制）

状況に応じて、以下を即時適用できるようにする：

- **Cron頻度を落とす**（Vercel側のスケジュール変更）
- **通知を止める**（デモ/本番でのSlack通知を一時停止）
  - デモは DM固定なので被害は小さいが、本番はチャンネル荒れを防ぐ
- **手動発動（訓練API）で運用継続**
  - 災害依存を避ける手段として、デモ/本番ともに「手動起動の導線」を維持する

### 4) 恒久対応（実装修正の方針）

仕様変更時に最も壊れやすいのは `entry_key` と `content_hash` です。修正優先度は以下：

1. **例外で落ちない**（パースは `try/catch`、異常時は 200で `ok:false` などの扱いを検討）
2. **entry_key の安定化**
   - `id` が不安定なら `link.href` や別要素にフォールバック
   - どうしても安定しない場合は、暫定で「feed + title + updated + link」の組み合わせ等に寄せる
3. **content_hash の安定化**
   - 変更検知に使うフィールドを見直す（変わりやすい値を除外）
4. **ノイズ制御**
   - `changed` が大量のときは「まとめ通知」または「通知抑制（管理者のみ）」を追加

### 5) 検証（デモ環境を先に使う）

手順：

1. **デモ環境で Cron を手動実行**：`GET /api/cron/jma?token=...`
2. DB（デモ）で `jma_entries` の増え方/更新の落ち着き方を確認
3. デモDM通知が「過剰にならない」ことを確認

### 6) 本番反映（段階導入）

推奨：

- デモ → 本番の順で反映
- 反映直後は Cron頻度を下げて様子見 → 問題なければ戻す

## 運用メモ（記録すべきこと）

- 仕様変更の内容（いつ/どこが変わったか）
- 影響（通知ノイズ、欠測、誤検知など）
- 対応（暫定策と恒久策）
- 再発防止（監視の追加、フォールバック、テストケース）

